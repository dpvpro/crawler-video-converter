# Video Converter - Автоматизированная конвертация видео

Программа для автоматической конвертации видео файлов с использованием FFmpeg. Рекурсивно обходит указанный каталог, находит видео файлы с заданными расширениями и конвертирует их в формат MKV с кодеком AV1.

## Возможности

- Рекурсивный обход каталогов
- Автоматическое создание каталога `converted` для результатов
- Проверка существующих конвертированных файлов (пропуск уже обработанных)
- Одно-процессная конвертация с контролем нагрузки на CPU через ограничение потоков FFmpeg
- Корректная обработка ошибок
- Безопасная конвертация с маркерами неполных файлов
- Сохранение даты модификации оригинальных файлов для конвертированных
- Корректное завершение при получении сигналов прерывания (Ctrl+C)

## Требования

- Go 1.25 или выше
- FFmpeg с поддержкой кодека libsvtav1
- Операционная система: Linux, macOS или Windows

## Установка

### 1. Установка FFmpeg

#### Ubuntu/Debian:

```bash
sudo apt update
sudo apt install ffmpeg
```

#### macOS:

```bash
brew install ffmpeg
```

#### Windows:

Скачайте FFmpeg с [официального сайта](https://ffmpeg.org/download.html) и добавьте в PATH.

### 2. Сборка программы

```bash
# Клонирование или переход в каталог проекта
cd crawler-video-converter

# Сборка
go build -o crawler-video-converter
```

## Использование

```bash
./crawler-video-converter <путь_к_каталогу>
```

### Пример:

```bash
./crawler-video-converter /home/user/videos
```

Программа:

1. Рекурсивно обойдет указанный каталог
2. Найдет все файлы с расширениями `.MOV`, `.mov`, `.MP4`, `.mp4`, `.AVI`, `.avi`
3. Для каждого файла создаст каталог `converted` на том же уровне
4. Конвертирует видео в формат MKV с кодеком AV1 (один процесс за раз)
5. Пропустит файлы, которые уже были конвертированы

## Настройки

Настройки программы задаются константами в файле `main.go`:

- **sourceExtensions**: Расширения исходных файлов (по умолчанию: `.mov,.MOV,.mp4,.MP4,.avi,.AVI`)
- **outputExtension**: Выходное расширение (по умолчанию: `.mkv`)
- **convertedDir**: Имя каталога для результатов (по умолчанию: `converted`)
- **targetCpuPercent**: Целевая загрузка CPU в процентах (по умолчанию: 50%)
- **niceLevel**: Приоритет процесса FFmpeg (0-19, больше = ниже приоритет, по умолчанию: 10)

### Контроль нагрузки CPU

Программа использует параметр `targetCpuPercent` для расчета количества потоков FFmpeg:

- Для 8-ядерного CPU с targetCpuPercent=50: будет использовано 4 потока
- Для 4-ядерного CPU с targetCpuPercent=50: будет использовано 2 потока

## Параметры конвертации

Программа использует следующие параметры FFmpeg:

- **Видео кодек**: libsvtav1 (AV1)
- **CRF**: 25 (качество, меньше = лучше качество, больше размер)
- **Preset**: 8 (скорость кодирования, 0 = медленно/лучше, 12 = быстро/хуже)
- **Аудио кодек**: AAC
- **Аудио битрейт**: 128k
- **Потоки**: автоматически рассчитывается на основе targetCpuPercent

## Структура результатов

```
videos/
├── video1.MOV
├── video2.mp4
├── converted/          # Создается автоматически
│   ├── video1.mkv
│   └── video2.mkv
│   └── video3.mkv.incomplete  # Маркер неполного файла (удаляется после успешной конвертации)
└── subfolder/
    ├── video3.avi
    └── converted/      # Создается автоматически
        └── video3.mkv
```

## Обработка ошибок

- Если конвертация не удалась, неполный файл удаляется
- Оригинальные файлы никогда не изменяются и не удаляются
- Ошибки логируются с указанием файла
- При получении сигнала прерывания (Ctrl+C) текущий процесс корректно завершается

## Примеры вывода

```
Начинаем обработку каталога: /home/user/videos
Поиск файлов с расширениями: .mov,.MOV,.mp4,.MP4,.avi,.AVI
Количество CPU ядер: 8
Целевая загрузка CPU: 50% (≈4 ядер)
Потоков на процесс ffmpeg: 4
Nice level: 10

Найдено 5 файлов для обработки

[НАЧАЛО] video1.MOV (threads=4)
[ПРОПУЩЕН] video2.mp4 (уже существует)
[УСПЕХ] video1.MOV -> video1.mkv
[НАЧАЛО] video3.avi (threads=4)
[УСПЕХ] video3.avi -> video3.mkv

===== Результаты обработки =====
Успешно конвертировано: 3
Пропущено (уже существует): 1
Ошибок: 1
```
