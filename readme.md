# Crawler Video Converter

Программа для автоматической конвертации видео файлов с использованием FFmpeg. Рекурсивно обходит указанный каталог, находит видео файлы с заданными расширениями и конвертирует их в формат MKV с кодеком AV1.

## Возможности

- Рекурсивный обход каталогов
- Автоматическое создание каталога `converted` для результатов
- Проверка существующих конвертированных файлов (пропуск уже обработанных)
- Одно-процессная конвертация с контролем нагрузки через ограничение потоков FFmpeg
- Корректная обработка ошибок
- Безопасная конвертация с маркерами неполных файлов
- Сохранение даты модификации оригинальных файлов для конвертированных
- Корректное завершение при получении сигналов прерывания (Ctrl+C)

## Требования

- Go 1.25 или выше
- FFmpeg с поддержкой кодека libsvtav1
- Операционная система: Linux

### Сборка программы

```bash
# Клонирование или переход в каталог проекта
cd crawler-video-converter

# Сборка
go build -o crawler-video-converter
```

## Использование

```bash
./crawler-video-converter [опции] <путь_к_каталогу>
```

### Опции:

- `-threads`, `-t`: Количество потоков для ffmpeg (по умолчанию: 2)

### Примеры:

```bash
# Использование по умолчанию (2 потока)
./crawler-video-converter /home/user/videos

# Указание количества потоков
./crawler-video-converter -threads 4 /home/user/videos

# Сокращенная форма
./crawler-video-converter -t 1 /home/user/videos
```

Программа:

1. Рекурсивно обойдет указанный каталог
2. Найдет все файлы с расширениями `.MOV`, `.mov`, `.MP4`, `.mp4`, `.AVI`, `.avi`
3. Для каждого файла создаст каталог `converted` на том же уровне
4. Конвертирует видео в формат MKV с кодеком AV1 (один процесс за раз)
5. Пропустит файлы, которые уже были конвертированы

## Настройки

Настройки программы задаются константами в файле `main.go`:

- **sourceExtensions**: Расширения исходных файлов (по умолчанию: `.mov,.MOV,.mp4,.MP4,.avi,.AVI`)
- **outputExtension**: Выходное расширение (по умолчанию: `.mkv`)
- **convertedDir**: Имя каталога для результатов (по умолчанию: `converted`)
- **defaultThreads**: Количество потоков ffmpeg по умолчанию (по умолчанию: 2)
- **niceLevel**: Приоритет процесса FFmpeg (0-19, больше = ниже приоритет, по умолчанию: 10)

### Контроль нагрузки CPU

Программа использует параметр `-threads` для ограничения количества потоков FFmpeg:

- Меньше потоков = меньше нагрузка на CPU, медленнее конвертация
- Больше потоков = больше нагрузка на CPU, быстрее конвертация
- Рекомендуемые значения: 1-8 потоков в зависимости от системы

## Параметры конвертации

Программа использует следующие параметры FFmpeg:

- **Видео кодек**: libsvtav1 (AV1)
- **CRF**: 25 (качество, меньше = лучше качество, больше размер)
- **Preset**: 8 (скорость кодирования, 0 = медленно/лучше, 12 = быстро/хуже)
- **Аудио кодек**: AAC
- **Аудио битрейт**: 128k
- **Потоки**: задаются через аргумент командной строки `-threads`

## Структура результатов

```
videos/
├── video1.MOV
├── video2.mp4
├── converted/          # Создается автоматически
│   ├── video1.mkv
│   └── video2.mkv
│   └── video3.mkv.incomplete  # Маркер неполного файла (удаляется после успешной конвертации)
└── subfolder/
    ├── video3.avi
    └── converted/      # Создается автоматически
        └── video3.mkv
```

## Обработка ошибок

- Если конвертация не удалась, неполный файл удаляется
- Оригинальные файлы никогда не изменяются и не удаляются
- Ошибки логируются с указанием файла
- При получении сигнала прерывания (Ctrl+C) текущий процесс корректно завершается

## Примеры вывода

```
Начинаем обработку каталога: /home/user/videos
Поиск файлов с расширениями: .mov,.MOV,.mp4,.MP4,.avi,.AVI
Потоков ffmpeg: 4
Nice level: 10

Найдено 5 файлов для обработки

[НАЧАЛО] video1.MOV (threads=4)
[ПРОПУЩЕН] video2.mp4 (уже существует)
[УСПЕХ] video1.MOV -> video1.mkv
[НАЧАЛО] video3.avi (threads=4)
[УСПЕХ] video3.avi -> video3.mkv

===== Результаты обработки =====
Успешно конвертировано: 3
Пропущено (уже существует): 1
Ошибок: 1
```
