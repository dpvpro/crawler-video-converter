# Video Converter - Автоматизированная конвертация видео

Программа для автоматической конвертации видео файлов с использованием FFmpeg. Рекурсивно обходит указанный каталог, находит видео файлы с заданными расширениями и конвертирует их в формат MKV с кодеком AV1.

## Возможности

- Рекурсивный обход каталогов
- Автоматическое создание каталога `converted` для результатов
- Проверка существующих конвертированных файлов (пропуск уже обработанных)
- Параллельная обработка с контролем нагрузки на CPU
- Корректная обработка ошибок
- Безопасная конвертация через временные файлы

## Требования

- Go 1.21 или выше
- FFmpeg с поддержкой кодека libsvtav1
- Операционная система: Linux, macOS или Windows

## Установка

### 1. Установка FFmpeg

#### Ubuntu/Debian:

```bash
sudo apt update
sudo apt install ffmpeg
```

#### macOS:

```bash
brew install ffmpeg
```

#### Windows:

Скачайте FFmpeg с [официального сайта](https://ffmpeg.org/download.html) и добавьте в PATH.

### 2. Сборка программы

```bash
# Клонирование или переход в каталог проекта
cd crawler-video-converter

# Сборка
go build -o video-converter

# Или установка в $GOPATH/bin
go install
```

## Использование

```bash
./video-converter <путь_к_каталогу>
```

### Пример:

```bash
./video-converter /home/user/videos
```

Программа:

1. Рекурсивно обойдет указанный каталог
2. Найдет все файлы с расширениями `.MOV`, `.mov`, `.MP4`, `.mp4`, `.AVI`, `.avi`
3. Для каждого файла создаст каталог `converted` на том же уровне
4. Конвертирует видео в формат MKV с кодеком AV1
5. Пропустит файлы, которые уже были конвертированы

## Настройки

Настройки программы задаются константами в файле `main.go`:

- **SOURCE_EXTENSIONS**: Расширения исходных файлов (по умолчанию: `.MOV,.mov,.MP4,.mp4,.AVI,.avi`)
- **OUTPUT_EXTENSION**: Выходное расширение (по умолчанию: `.mkv`)
- **CONVERTED_DIR**: Имя каталога для результатов (по умолчанию: `converted`)
- **MAX_WORKERS**: Максимальное количество одновременных конвертаций (по умолчанию: 2)

### Контроль нагрузки CPU

Программа использует параметр `MAX_WORKERS` для ограничения количества одновременных процессов конвертации. Рекомендуемые значения:

- Для 4-ядерного CPU: `MAX_WORKERS = 2`
- Для 8-ядерного CPU: `MAX_WORKERS = 3-4`
- Для 16-ядерного CPU: `MAX_WORKERS = 6-8`

## Параметры конвертации

Программа использует следующие параметры FFmpeg:

- **Видео кодек**: libsvtav1 (AV1)
- **CRF**: 35 (качество, меньше = лучше качество, больше размер)
- **Preset**: 8 (скорость кодирования, 0 = медленно/лучше, 12 = быстро/хуже)
- **Аудио кодек**: AAC
- **Аудио битрейт**: 128k

### Изменение параметров

Для изменения параметров конвертации отредактируйте команду FFmpeg в функции `processFile`:

```go
cmd := exec.Command("ffmpeg",
    "-i", file.sourcePath,
    "-c:v", "libsvtav1",  // Видео кодек
    "-crf", "35",          // Качество (0-63)
    "-preset", "8",        // Скорость (0-12)
    "-c:a", "aac",         // Аудио кодек
    "-b:a", "128k",        // Аудио битрейт
    "-y",
    tempPath,
)
```

## Структура каталогов

## Структура результатов

```
videos/
├── video1.MOV
├── video2.mp4
├── converted/          # Создается автоматически
│   ├── video1.mkv
│   └── video2.mkv
│   └── video3.mkv.incomplete  # Маркер неполного файла (удаляется после успешной конвертации)
└── subfolder/
    ├── video3.avi
    └── converted/      # Создается автоматически
        └── video3.mkv
```

## Обработка ошибок

- Если конвертация не удалась, временный файл удаляется
- Оригинальные файлы никогда не изменяются и не удаляются
- Каталоги `converted` пропускаются при рекурсивном обходе
- Ошибки логируются с указанием файла

## Примеры вывода

```
Начинаем обработку каталога: /home/user/videos
Поиск файлов с расширениями: .MOV,.mov,.MP4,.mp4,.AVI,.avi
Максимум параллельных конвертаций: 2
Количество CPU ядер: 8

Найдено 5 файлов для обработки

[НАЧАЛО] video1.MOV
[ПРОПУЩЕН] video2.mp4 (уже существует)
[ГОТОВО] video1.MOV -> video1.mkv
[НАЧАЛО] video3.avi
[ГОТОВО] video3.avi -> video3.mkv

===== Результаты обработки =====
Успешно конвертировано: 3
Пропущено (уже существует): 1
Ошибок: 1
```
